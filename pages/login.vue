<template>
  <div class="flex min-h-full flex-1 flex-col justify-center px-6 py-12 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-sm">
      <div class="flex justify-center">
        <svg
          fill="#63b81e"
          version="1.1"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          width="64px"
          height="64px"
          viewBox="0 0 512 512"
          enable-background="new 0 0 512 512"
          xml:space="preserve"
          stroke="#63b81e"
        ><g id="SVGRepo_bgCarrier" stroke-width="0" /><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" /><g id="SVGRepo_iconCarrier"> <g id="2069a460dcf28295e231f3111e042b0b"> <path display="inline" fill-rule="evenodd" clip-rule="evenodd" d="M256,0.5C114.894,0.5,0.502,114.887,0.502,256.002 C0.502,397.107,114.894,511.5,256,511.5s255.498-114.393,255.498-255.498C511.498,114.887,397.106,0.5,256,0.5z M271.399,468.875 c-8.014-4.741-17.695-6.841-25.82-11.478c-3.73-2.129-6.454-6.903-10.521-8.604c-4.67-1.963-10.654-1.123-15.295-2.874 c-10.845-4.088-22.057-13.802-30.606-21.038c-2.158-1.829-7.078-4.166-5.734-7.647c17.462,13.989,42.329,15.715,60.244,27.729 c18.085,12.13,34.624,23.637,50.68,36.341C286.178,480.265,279.641,473.749,271.399,468.875z M357.459,424.882 c-10.563-6.204-25.45-10.782-34.424-16.255c-8.7-5.298-18.123-19.092-27.733-21.999c-5.626-1.696-15.532,0.387-21.994-0.952 c-7.572-1.563-17.586-9.489-25.815-14.343c-24.145-14.238-53.57-29.986-77.457-41.119c5.248,13.532,15.308,27.953,25.816,39.206 c5.572,5.968,12.567,13.153,19.125,19.125c19.433,17.694,44.18,29.064,65.982,45.901c-20.289-9.743-52.155-23.291-73.63-37.293 c-12.039-7.852-22.614-11.402-32.516-20.081c-6.383-5.602-12.438-16.044-19.125-22.947c-6.633-6.865-16.218-14.476-23.902-22.002 c-5.964-5.83-18.988-17.736-27.733-17.212c-18.269,1.098-16.991,36.932-10.517,51.636c8.001,18.206,26.922,29.725,43.027,44.949 c16.514,15.615,31.601,30.407,43.989,41.119c-25.134-10.566-40.351-31.052-67.896-39.206c1.979,9.244,14.197,16.351,21.042,23.907 c-6.936-2.887-14.022-7.557-21.042-12.435c-14.105-9.806-28.681-14.001-41.119-26.772c-13.049-13.411-21.924-33.063-30.598-53.553 c-6.092-14.389-20.46-45.798-16.26-66.939c1.231-6.167,8.525-14.047,13.39-21.99c9.498-15.52,17.058-28.847,22.947-47.814 c2.877-9.257,2.699-21.383,6.695-27.732c4.258-6.766,14.813-9.544,21.038-14.343c21.652,14.492,18.451,43.049,30.602,62.153 c4.217,6.632,11.27,8.898,16.256,13.39c9.244,8.33,16.921,20.743,26.776,30.599c9.307,9.307,18.904,19.939,28.686,27.732 c8.338,6.646,19.004,12.588,28.693,21.038c17.94,15.657,34.429,31.509,59.288,40.167c15.49,5.394,38.645,5.768,41.119,22.946 c29.509,15.116,48.359,40.887,87.017,46.858C394.985,454.462,375.183,435.287,357.459,424.882z M439.701,314.911 c-2.836-6.325-6.77-12.542-10.524-19.121c-7.282-12.792-11.146-28.07-21.99-37.302c-18.281,15.819-29.271,37.248-45.901,54.514 c-8.321,8.638-17.412,15.361-26.772,22.951c-9.078,7.348-16.842,17.391-28.689,21.037c13.444-25.454,38.915-40.1,57.374-61.2 c18.88-21.587,26.07-50.525,42.076-76.5c0.503-0.773,1.002-1.555,0.956-2.869c3.677,3.335,8.126,5.896,12.435,8.604 c6.237,14.879,7.572,28.307,14.342,43.988c3.123,7.231,9.86,14.326,14.343,21.994c4.778,8.167,7.036,16.971,10.518,24.859 c6.645,15.054,22.489,27.958,5.738,43.988C448.035,351.884,447.395,332.11,439.701,314.911z" /> </g> </g></svg>
      </div>
      <h2 class="mt-10 text-center text-2xl font-bold leading-9 tracking-tight text-gray-900">
        Sign in to your account
      </h2>
    </div>

    <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
      <Form
        v-slot="{ errors }"
        class="space-y-6"
        action="#"
        :validation-schema="schema"
        @submit="login"
      >
        <div>
          <label for="email" class="block text-sm font-medium leading-6 text-gray-900">User name</label>
          <div class="mt-2">
            <Field
              id="email"
              v-model="user.username"
              name="username"
              type="text"
              autocomplete="username"
              required
              validate-on-input
              placeholder="User Name"
              :class="errors.username ? `invalid:border-red-500 invalid:text-red-600 focus:invalid:border-red-500 focus:invalid:ring-red-500` : `focus:border-indigo-500 focus:ring-indigo-500`"
              class="px-3 py-2 bg-white border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none block w-full rounded-md sm:text-sm focus:ring-1 disabled:shadow-none"
            />
            <span class="invalid-feedback text-red-500 text-sm">
              {{ errors.username }}
            </span>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <label for="password" class="block text-sm font-medium leading-6 text-gray-900">Password</label>
          </div>
          <div class="mt-2">
            <Field
              id="password"
              v-model="user.password"
              name="password"
              type="password"
              autocomplete="current-password"
              placeholder="Password"
              required
              validate-on-input
              :class="errors.password ? `invalid:border-red-500 invalid:text-red-600 focus:invalid:border-red-500 focus:invalid:ring-red-500` : `focus:border-indigo-500 focus:ring-indigo-500`"
              class="px-3 py-2 bg-white border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none block w-full rounded-md sm:text-sm focus:ring-1 disabled:shadow-none"
            />
            <span class="invalid-feedback text-red-500 text-sm">
              {{ errors.password }}
            </span>
          </div>
        </div>

        <div>
          <button
            type="submit"
            class="flex w-full justify-center items-center px-4 py-2 font-semibold leading-6 text-sm rounded-md text-white transition ease-in-out duration-150"
            :class="isLoading ? `bg-blue-500 hover:bg-blue-400 cursor-not-allowed` : `bg-blue-700 hover:bg-blue-600`"
            :disabled="isLoading"
          >
            <template v-if="isLoading">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                />
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
              Processing...
            </template>
            <template v-else>
              Sign in
            </template>
          </button>
        </div>
      </Form>
    </div>
  </div>
</template>
<script lang="ts" setup>
import { ref } from 'vue'
import { Form, Field } from 'vee-validate'
import * as Yup from 'yup'
import { storeToRefs } from 'pinia'
import { useAuthStore } from '~/store/auth'
import { useNotificationStore } from '~/store/notification'
const notification = useNotificationStore()
definePageMeta({
  layout: 'blank'
})
const { authenticateUser } = useAuthStore()

const { authenticated } = storeToRefs(useAuthStore())
const isLoading = ref(false)
const user = ref({
  username: '',
  password: ''
})
const router = useRouter()
const schema = Yup.object().shape({
  username: Yup.string()
    .required('User name is required | hint: kminchelle'),
  password: Yup.string()
    .min(6, 'Password must be at least 6 characters | hint: 0lelplR')
    .required('Password is required | hint: 0lelplR')
})
const login = async () => {
  try {
    isLoading.value = true
    await authenticateUser(user.value)
    if (!authenticated.value) {
      throw new Error('Login failed. Please try again.')
    }
    router.push('/')
  } catch (err) {
    isLoading.value = false
    notification.showNotification('Error', 'Login failed. Please try again.', 'error')
  }
}
</script>
